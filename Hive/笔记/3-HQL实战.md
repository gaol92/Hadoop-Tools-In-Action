### 1、HQL实战  
有三张表：`exer_student`（学生信息表）、`exer_sc`（学生选课情况表）、`exer_course`（课程信息表），分别如下：  
`exer_student`：  
```
+-------------------+---------------------+-------------------+--------------------+---------------------+--+
| exer_student.sno  | exer_student.sname  | exer_student.sex  | exer_student.sage  | exer_student.sdept  |
+-------------------+---------------------+-------------------+--------------------+---------------------+--+
| 95001             | 李勇                  | 男                 | 20                 | CS                  |
| 95002             | 刘晨                  | 女                 | 19                 | IS                  |
| 95003             | 王敏                  | 女                 | 22                 | MA                  |
| 95004             | 张立                  | 男                 | 19                 | IS                  |
| 95005             | 刘刚                  | 男                 | 18                 | MA                  |
| 95006             | 孙庆                  | 男                 | 23                 | CS                  |
| 95007             | 易思玲                 | 女                 | 19                 | MA                  |
| 95008             | 李娜                  | 女                 | 18                 | CS                  |
| 95009             | 梦圆圆                 | 女                 | 18                 | MA                  |
| 95010             | 孔小涛                 | 男                 | 19                 | CS                  |
| 95011             | 包小柏                 | 男                 | 18                 | MA                  |
| 95012             | 孙花                  | 女                 | 20                 | CS                  |
| 95013             | 冯伟                  | 男                 | 21                 | CS                  |
| 95014             | 王小丽                 | 女                 | 19                 | CS                  |
| 95015             | 王君                  | 男                 | 18                 | MA                  |
| 95016             | 钱国                  | 男                 | 21                 | MA                  |
| 95017             | 王风娟                 | 女                 | 18                 | IS                  |
| 95018             | 王一                  | 女                 | 19                 | IS                  |
| 95019             | 邢小丽                 | 女                 | 19                 | IS                  |
| 95020             | 赵钱                  | 男                 | 21                 | IS                  |
| 95021             | 周二                  | 男                 | 17                 | MA                  |
| 95022             | 郑明                  | 男                 | 20                 | MA                  |
+-------------------+---------------------+-------------------+--------------------+---------------------+--+
```  
`exer_sc`：
```
+--------------+--------------+----------------+--+
| exer_sc.sno  | exer_sc.cno  | exer_sc.grade  |
+--------------+--------------+----------------+--+
| 95001        | 1            | 81             |
| 95001        | 2            | 85             |
| 95001        | 3            | 88             |
| 95001        | 4            | 70             |
| 95002        | 2            | 90             |
| 95002        | 3            | 80             |
| 95002        | 4            | 71             |
| 95002        | 5            | 60             |
| 95003        | 1            | 82             |
| 95003        | 3            | 90             |
| 95003        | 5            | 100            |
| 95004        | 1            | 80             |
| 95004        | 2            | 92             |
| 95004        | 4            | 91             |
| 95004        | 5            | 70             |
| 95005        | 1            | 70             |
| 95005        | 2            | 92             |
| 95005        | 3            | 99             |
| 95005        | 6            | 87             |
| 95006        | 1            | 72             |
| 95006        | 2            | 62             |
| 95006        | 3            | 100            |
| 95006        | 4            | 59             |
| 95006        | 5            | 60             |
| 95006        | 6            | 98             |
| 95007        | 3            | 68             |
| 95007        | 4            | 91             |
| 95007        | 5            | 94             |
| 95007        | 6            | 78             |
| 95008        | 1            | 98             |
| 95008        | 3            | 89             |
| 95008        | 6            | 91             |
| 95009        | 2            | 81             |
| 95009        | 4            | 89             |
| 95009        | 6            | 100            |
| 95010        | 2            | 98             |
| 95010        | 5            | 90             |
| 95010        | 6            | 80             |
| 95011        | 1            | 81             |
| 95011        | 2            | 91             |
| 95011        | 3            | 81             |
| 95011        | 4            | 86             |
| 95012        | 1            | 81             |
| 95012        | 3            | 78             |
| 95012        | 4            | 85             |
| 95012        | 6            | 98             |
| 95013        | 1            | 98             |
| 95013        | 2            | 58             |
| 95013        | 4            | 88             |
| 95013        | 5            | 93             |
| 95014        | 1            | 91             |
| 95014        | 2            | 100            |
| 95014        | 4            | 98             |
| 95015        | 1            | 91             |
| 95015        | 3            | 59             |
| 95015        | 4            | 100            |
| 95015        | 6            | 95             |
| 95016        | 1            | 92             |
| 95016        | 2            | 99             |
| 95016        | 4            | 82             |
| 95017        | 4            | 82             |
| 95017        | 5            | 100            |
| 95017        | 6            | 58             |
| 95018        | 1            | 95             |
| 95018        | 2            | 100            |
| 95018        | 3            | 67             |
| 95018        | 4            | 78             |
| 95019        | 1            | 77             |
| 95019        | 2            | 90             |
| 95019        | 3            | 91             |
| 95019        | 4            | 67             |
| 95019        | 5            | 87             |
| 95020        | 1            | 66             |
| 95020        | 2            | 99             |
| 95020        | 5            | 93             |
| 95021        | 2            | 93             |
| 95021        | 5            | 91             |
| 95021        | 6            | 99             |
| 95022        | 3            | 69             |
| 95022        | 4            | 93             |
| 95022        | 5            | 82             |
| 95022        | 6            | 100            |
+--------------+--------------+----------------+--+
```
`exer_course`：
```
+------------------+--------------------+--+
| exer_course.cno  | exer_course.cname  |
+------------------+--------------------+--+
| 1                | 数据库                |
| 2                | 数学                 |
| 3                | 信息系统               |
| 4                | 操作系统               |
| 5                | 数据结构               |
| 6                | 数据处理               |
+------------------+--------------------+--+
```
- 查询选修了课程的学生姓名和对应的课程名称：
    - HQL：
    ```
    select t.sname,b.cname from (select sname,cno from exer_student t1 join exer_sc t2 on t1.sno = t2.sno) t join exer_course b on t.cno = b.cno;
    ```  
    或  
    ```
    select sname,cname from exer_student t1 join exer_sc t2 on t1.sno = t2.sno join exer_course t3 on t2.cno = t3.cno;
    ```
    - 查询结果：
    ```
    +----------+----------+--+
    | t.sname  | b.cname  |
    +----------+----------+--+
    | 李勇       | 数据库      |
    | 李勇       | 数学       |
    | 李勇       | 信息系统     |
    | 李勇       | 操作系统     |
    | 刘晨       | 数学       |
    | 刘晨       | 信息系统     |
    | 刘晨       | 操作系统     |
    | 刘晨       | 数据结构     |
    | 王敏       | 数据库      |
    | 王敏       | 信息系统     |
    | 王敏       | 数据结构     |
    | 张立       | 数据库      |
    | 张立       | 数学       |
    | 张立       | 操作系统     |
    | 张立       | 数据结构     |
    | 刘刚       | 数据库      |
    | 刘刚       | 数学       |
    | 刘刚       | 信息系统     |
    | 刘刚       | 数据处理     |
    | 孙庆       | 数据库      |
    | 孙庆       | 数学       |
    | 孙庆       | 信息系统     |
    | 孙庆       | 操作系统     |
    | 孙庆       | 数据结构     |
    | 孙庆       | 数据处理     |
    | 易思玲      | 信息系统     |
    | 易思玲      | 操作系统     |
    | 易思玲      | 数据结构     |
    | 易思玲      | 数据处理     |
    | 李娜       | 数据库      |
    | 李娜       | 信息系统     |
    | 李娜       | 数据处理     |
    | 梦圆圆      | 数学       |
    | 梦圆圆      | 操作系统     |
    | 梦圆圆      | 数据处理     |
    | 孔小涛      | 数学       |
    | 孔小涛      | 数据结构     |
    | 孔小涛      | 数据处理     |
    | 包小柏      | 数据库      |
    | 包小柏      | 数学       |
    | 包小柏      | 信息系统     |
    | 包小柏      | 操作系统     |
    | 孙花       | 数据库      |
    | 孙花       | 信息系统     |
    | 孙花       | 操作系统     |
    | 孙花       | 数据处理     |
    | 冯伟       | 数据库      |
    | 冯伟       | 数学       |
    | 冯伟       | 操作系统     |
    | 冯伟       | 数据结构     |
    | 王小丽      | 数据库      |
    | 王小丽      | 数学       |
    | 王小丽      | 操作系统     |
    | 王君       | 数据库      |
    | 王君       | 信息系统     |
    | 王君       | 操作系统     |
    | 王君       | 数据处理     |
    | 钱国       | 数据库      |
    | 钱国       | 数学       |
    | 钱国       | 操作系统     |
    | 王风娟      | 操作系统     |
    | 王风娟      | 数据结构     |
    | 王风娟      | 数据处理     |
    | 王一       | 数据库      |
    | 王一       | 数学       |
    | 王一       | 信息系统     |
    | 王一       | 操作系统     |
    | 邢小丽      | 数据库      |
    | 邢小丽      | 数学       |
    | 邢小丽      | 信息系统     |
    | 邢小丽      | 操作系统     |
    | 邢小丽      | 数据结构     |
    | 赵钱       | 数据库      |
    | 赵钱       | 数学       |
    | 赵钱       | 数据结构     |
    | 周二       | 数学       |
    | 周二       | 数据结构     |
    | 周二       | 数据处理     |
    | 郑明       | 信息系统     |
    | 郑明       | 操作系统     |
    | 郑明       | 数据结构     |
    | 郑明       | 数据处理     |
    +----------+----------+--+

    ```
- 查询各科成绩平均分，显示格式为：`课程名称 - 平均分`
    - HQL：
    ```
    select b.cname,t.average from (select cno,avg(grade) average from exer_sc group by cno) t join exer_course b on t.cno = b.cno;
    ```
    - 查询结果：
    ```
    +----------+--------------------+--+
    | b.cname  |     t.average      |
    +----------+--------------------+--+
    | 操作系统     | 83.125             |
    | 数据库      | 83.66666666666667  |
    | 数据结构     | 85.0               |
    | 数学       | 88.66666666666667  |
    | 数据处理     | 89.45454545454545  |
    | 信息系统     | 81.46153846153847  |
    +----------+--------------------+--+
    ```
- 查询选修1号课程的学生最高分数
    - HQL：
    ```
    select max(grade) from exer_sc where cno = '1'; -- 这种方式没办法查出最高分学生的学号
    ```  
    或  
    ```
    select sno,grade from exer_sc where cno = '1' order by grade desc limit 1;
    ```  
    ==注意：==  
    1.`order by`是全局排序，即便设置了`set mapreduce.job.reduces=4;`，hive在编译期间也会将reduce数量强行设为1。当reduce数量为1个时，`sort by`是将全部的数据当做了一个桶来排序，所以此时它的作用就相当于`order by`。  
    2.在strict模式下（`hive.mapred.mode=strict`)，`order by`语句必须跟着`limit`语句（这样做是因为当reduce数量为1个时，防止`order by`全局排序使得这1个reducer崩了），但是在nonstrict下`limit`就不是必须的。
    - 查询结果：
    ```
    +--------+--------+--+
    |  sno   | grade  |
    +--------+--------+--+
    | 95008  | 98     |
    +--------+--------+--+
    ```
- 查询选修了3门以上的课程的学生学号
    - HQL：
    ```
    select t.no,t.cnt from (select sno no,count(sno) cnt from exer_sc group by sno) t where t.cnt >= 3;
    ```
    或
    ```
    select sno,count(sno) from exer_sc group by sno having count(cno) >=3;
    ```
    - 查询结果：
    ```
    +--------+------+--+
    |  sno   | _c1  |
    +--------+------+--+
    | 95001  | 4    |
    | 95002  | 4    |
    | 95003  | 3    |
    | 95004  | 4    |
    | 95005  | 4    |
    | 95006  | 6    |
    | 95007  | 4    |
    | 95008  | 3    |
    | 95009  | 3    |
    | 95010  | 3    |
    | 95011  | 4    |
    | 95012  | 4    |
    | 95013  | 4    |
    | 95014  | 3    |
    | 95015  | 4    |
    | 95016  | 3    |
    | 95017  | 3    |
    | 95018  | 4    |
    | 95019  | 5    |
    | 95020  | 3    |
    | 95021  | 3    |
    | 95022  | 4    |
    +--------+------+--+
    ```
- 查询学生信息，按性别分区，在分区内按年龄有序：
    - HQL：
    ```
    set mapreduce.job.reduces=2;
    
    insert overwrite local directory '/root/hadoop_testfiles/hive_output2'
    select * from exer_student distribute by (sex) sort by (sage);
    ```
    - 查询结果：  
    linux本地目录`/root/hadoop_testfiles/hive_output2`下生成两个文件：`000000_0`和`000001_1`（两个reducer生成的结果文件）  
    `000000_0`内容：
    ```
        1 95021^A周二^A男^A17^AMA
        2 95015^A王君^A男^A18^AMA
        3 95005^A刘刚^A男^A18^AMA
        4 95011^A包小柏^A男^A18^AMA
        5 95004^A张立^A男^A19^AIS
        6 95010^A孔小涛^A男^A19^ACS
        7 95022^A郑明^A男^A20^AMA
        8 95001^A李勇^A男^A20^ACS
        9 95016^A钱国^A男^A21^AMA
       10 95020^A赵钱^A男^A21^AIS
       11 95013^A冯伟^A男^A21^ACS
       12 95006^A孙庆^A男^A23^ACS
    ```  
    `000001_1`内容：
    ```
      1 95017^A王风娟^A女^A18^AIS
      2 95009^A梦圆圆^A女^A18^AMA
      3 95008^A李娜^A女^A18^ACS
      4 95014^A王小丽^A女^A19^ACS
      5 95018^A王一^A女^A19^AIS
      6 95019^A邢小丽^A女^A19^AIS
      7 95002^A刘晨^A女^A19^AIS
      8 95007^A易思玲^A女^A19^AMA
      9 95012^A孙花^A女^A20^ACS
     10 95003^A王敏^A女^A22^AMA
    ```
- 查询每个学生及其选修课程的情况
    - HQL：
    ```
    select t1.sno,t1.sname,t1.sex,t1.sage,t1.sdept,t2.cno,t3.cname,t2.grade  from exer_student t1 join exer_sc t2 on t1.sno = t2.sno join exer_course t3 on t2.cno = t3.cno;
    ```  
    或
    ```
    select t1.*,t2.*,t3.*from exer_student t1 join exer_sc t2 on t1.sno = t2.sno join exer_course t3 on t2.cno = t3.cno;
    ```
    - 查询结果
    ```
    +---------+-----------+---------+----------+-----------+---------+-----------+-----------+--+
    | t1.sno  | t1.sname  | t1.sex  | t1.sage  | t1.sdept  | t2.cno  | t3.cname  | t2.grade  |
    +---------+-----------+---------+----------+-----------+---------+-----------+-----------+--+
    | 95001   | 李勇        | 男       | 20       | CS        | 1       | 数据库       | 81        |
    | 95001   | 李勇        | 男       | 20       | CS        | 2       | 数学        | 85        |
    | 95001   | 李勇        | 男       | 20       | CS        | 3       | 信息系统      | 88        |
    | 95001   | 李勇        | 男       | 20       | CS        | 4       | 操作系统      | 70        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 2       | 数学        | 90        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 3       | 信息系统      | 80        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 4       | 操作系统      | 71        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 5       | 数据结构      | 60        |
    | 95003   | 王敏        | 女       | 22       | MA        | 1       | 数据库       | 82        |
    | 95003   | 王敏        | 女       | 22       | MA        | 3       | 信息系统      | 90        |
    | 95003   | 王敏        | 女       | 22       | MA        | 5       | 数据结构      | 100       |
    | 95004   | 张立        | 男       | 19       | IS        | 1       | 数据库       | 80        |
    | 95004   | 张立        | 男       | 19       | IS        | 2       | 数学        | 92        |
    | 95004   | 张立        | 男       | 19       | IS        | 4       | 操作系统      | 91        |
    | 95004   | 张立        | 男       | 19       | IS        | 5       | 数据结构      | 70        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 1       | 数据库       | 70        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 2       | 数学        | 92        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 3       | 信息系统      | 99        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 6       | 数据处理      | 87        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 1       | 数据库       | 72        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 2       | 数学        | 62        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 3       | 信息系统      | 100       |
    | 95006   | 孙庆        | 男       | 23       | CS        | 4       | 操作系统      | 59        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 5       | 数据结构      | 60        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 6       | 数据处理      | 98        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 3       | 信息系统      | 68        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 4       | 操作系统      | 91        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 5       | 数据结构      | 94        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 6       | 数据处理      | 78        |
    | 95008   | 李娜        | 女       | 18       | CS        | 1       | 数据库       | 98        |
    | 95008   | 李娜        | 女       | 18       | CS        | 3       | 信息系统      | 89        |
    | 95008   | 李娜        | 女       | 18       | CS        | 6       | 数据处理      | 91        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 2       | 数学        | 81        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 4       | 操作系统      | 89        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 6       | 数据处理      | 100       |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 2       | 数学        | 98        |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 5       | 数据结构      | 90        |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 6       | 数据处理      | 80        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 1       | 数据库       | 81        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 2       | 数学        | 91        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 3       | 信息系统      | 81        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 4       | 操作系统      | 86        |
    | 95012   | 孙花        | 女       | 20       | CS        | 1       | 数据库       | 81        |
    | 95012   | 孙花        | 女       | 20       | CS        | 3       | 信息系统      | 78        |
    | 95012   | 孙花        | 女       | 20       | CS        | 4       | 操作系统      | 85        |
    | 95012   | 孙花        | 女       | 20       | CS        | 6       | 数据处理      | 98        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 1       | 数据库       | 98        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 2       | 数学        | 58        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 4       | 操作系统      | 88        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 5       | 数据结构      | 93        |
    | 95014   | 王小丽       | 女       | 19       | CS        | 1       | 数据库       | 91        |
    | 95014   | 王小丽       | 女       | 19       | CS        | 2       | 数学        | 100       |
    | 95014   | 王小丽       | 女       | 19       | CS        | 4       | 操作系统      | 98        |
    | 95015   | 王君        | 男       | 18       | MA        | 1       | 数据库       | 91        |
    | 95015   | 王君        | 男       | 18       | MA        | 3       | 信息系统      | 59        |
    | 95015   | 王君        | 男       | 18       | MA        | 4       | 操作系统      | 100       |
    | 95015   | 王君        | 男       | 18       | MA        | 6       | 数据处理      | 95        |
    | 95016   | 钱国        | 男       | 21       | MA        | 1       | 数据库       | 92        |
    | 95016   | 钱国        | 男       | 21       | MA        | 2       | 数学        | 99        |
    | 95016   | 钱国        | 男       | 21       | MA        | 4       | 操作系统      | 82        |
    | 95017   | 王风娟       | 女       | 18       | IS        | 4       | 操作系统      | 82        |
    | 95017   | 王风娟       | 女       | 18       | IS        | 5       | 数据结构      | 100       |
    | 95017   | 王风娟       | 女       | 18       | IS        | 6       | 数据处理      | 58        |
    | 95018   | 王一        | 女       | 19       | IS        | 1       | 数据库       | 95        |
    | 95018   | 王一        | 女       | 19       | IS        | 2       | 数学        | 100       |
    | 95018   | 王一        | 女       | 19       | IS        | 3       | 信息系统      | 67        |
    | 95018   | 王一        | 女       | 19       | IS        | 4       | 操作系统      | 78        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 1       | 数据库       | 77        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 2       | 数学        | 90        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 3       | 信息系统      | 91        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 4       | 操作系统      | 67        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 5       | 数据结构      | 87        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 1       | 数据库       | 66        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 2       | 数学        | 99        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 5       | 数据结构      | 93        |
    | 95021   | 周二        | 男       | 17       | MA        | 2       | 数学        | 93        |
    | 95021   | 周二        | 男       | 17       | MA        | 5       | 数据结构      | 91        |
    | 95021   | 周二        | 男       | 17       | MA        | 6       | 数据处理      | 99        |
    | 95022   | 郑明        | 男       | 20       | MA        | 3       | 信息系统      | 69        |
    | 95022   | 郑明        | 男       | 20       | MA        | 4       | 操作系统      | 93        |
    | 95022   | 郑明        | 男       | 20       | MA        | 5       | 数据结构      | 82        |
    | 95022   | 郑明        | 男       | 20       | MA        | 6       | 数据处理      | 100       |
    +---------+-----------+---------+----------+-----------+---------+-----------+-----------+--+
    ```
- 查询选修2号课程且成绩在90分以上的所有学生
    - HQL：
    ```
    select t.sno,t1.sname,t.cno,t.grade from exer_student t1 join exer_sc t on t.sno = t1.sno where t.cno = 2 and t.grade >= 90;
    ```
    - 查询结果：
    ```
    +--------+-----------+--------+----------+--+
    | t.sno  | t1.sname  | t.cno  | t.grade  |
    +--------+-----------+--------+----------+--+
    | 95002  | 刘晨        | 2      | 90       |
    | 95004  | 张立        | 2      | 92       |
    | 95005  | 刘刚        | 2      | 92       |
    | 95010  | 孔小涛       | 2      | 98       |
    | 95011  | 包小柏       | 2      | 91       |
    | 95014  | 王小丽       | 2      | 100      |
    | 95016  | 钱国        | 2      | 99       |
    | 95018  | 王一        | 2      | 100      |
    | 95019  | 邢小丽       | 2      | 90       |
    | 95020  | 赵钱        | 2      | 99       |
    | 95021  | 周二        | 2      | 93       |
    +--------+-----------+--------+----------+--+
    ```
- 查询所有学生的信息，如果在成绩表中有成绩，则输出成绩表中的课程号
    - HQL：
    ```
    select t2.*,t1.cno,t1.grade from exer_sc t1 left join exer_student t2 on t1.sno = t2.sno; -- 这样写是因为所有的学生都选课了，数据主控方是exer_student或exer_sc都可以
    ```
    或
    ```
    select t1.*,t2.cno,t2.grade from exer_student t1 left join exer_sc t2 on t1.sno = t2.sno;
    ```
    - 查询结果：
    ```
    +---------+-----------+---------+----------+-----------+---------+-----------+--+
    | t1.sno  | t1.sname  | t1.sex  | t1.sage  | t1.sdept  | t2.cno  | t2.grade  |
    +---------+-----------+---------+----------+-----------+---------+-----------+--+
    | 95001   | 李勇        | 男       | 20       | CS        | 1       | 81        |
    | 95001   | 李勇        | 男       | 20       | CS        | 2       | 85        |
    | 95001   | 李勇        | 男       | 20       | CS        | 3       | 88        |
    | 95001   | 李勇        | 男       | 20       | CS        | 4       | 70        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 2       | 90        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 3       | 80        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 4       | 71        |
    | 95002   | 刘晨        | 女       | 19       | IS        | 5       | 60        |
    | 95003   | 王敏        | 女       | 22       | MA        | 1       | 82        |
    | 95003   | 王敏        | 女       | 22       | MA        | 3       | 90        |
    | 95003   | 王敏        | 女       | 22       | MA        | 5       | 100       |
    | 95004   | 张立        | 男       | 19       | IS        | 1       | 80        |
    | 95004   | 张立        | 男       | 19       | IS        | 2       | 92        |
    | 95004   | 张立        | 男       | 19       | IS        | 4       | 91        |
    | 95004   | 张立        | 男       | 19       | IS        | 5       | 70        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 1       | 70        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 2       | 92        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 3       | 99        |
    | 95005   | 刘刚        | 男       | 18       | MA        | 6       | 87        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 1       | 72        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 2       | 62        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 3       | 100       |
    | 95006   | 孙庆        | 男       | 23       | CS        | 4       | 59        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 5       | 60        |
    | 95006   | 孙庆        | 男       | 23       | CS        | 6       | 98        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 3       | 68        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 4       | 91        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 5       | 94        |
    | 95007   | 易思玲       | 女       | 19       | MA        | 6       | 78        |
    | 95008   | 李娜        | 女       | 18       | CS        | 1       | 98        |
    | 95008   | 李娜        | 女       | 18       | CS        | 3       | 89        |
    | 95008   | 李娜        | 女       | 18       | CS        | 6       | 91        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 2       | 81        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 4       | 89        |
    | 95009   | 梦圆圆       | 女       | 18       | MA        | 6       | 100       |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 2       | 98        |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 5       | 90        |
    | 95010   | 孔小涛       | 男       | 19       | CS        | 6       | 80        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 1       | 81        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 2       | 91        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 3       | 81        |
    | 95011   | 包小柏       | 男       | 18       | MA        | 4       | 86        |
    | 95012   | 孙花        | 女       | 20       | CS        | 1       | 81        |
    | 95012   | 孙花        | 女       | 20       | CS        | 3       | 78        |
    | 95012   | 孙花        | 女       | 20       | CS        | 4       | 85        |
    | 95012   | 孙花        | 女       | 20       | CS        | 6       | 98        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 1       | 98        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 2       | 58        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 4       | 88        |
    | 95013   | 冯伟        | 男       | 21       | CS        | 5       | 93        |
    | 95014   | 王小丽       | 女       | 19       | CS        | 1       | 91        |
    | 95014   | 王小丽       | 女       | 19       | CS        | 2       | 100       |
    | 95014   | 王小丽       | 女       | 19       | CS        | 4       | 98        |
    | 95015   | 王君        | 男       | 18       | MA        | 1       | 91        |
    | 95015   | 王君        | 男       | 18       | MA        | 3       | 59        |
    | 95015   | 王君        | 男       | 18       | MA        | 4       | 100       |
    | 95015   | 王君        | 男       | 18       | MA        | 6       | 95        |
    | 95016   | 钱国        | 男       | 21       | MA        | 1       | 92        |
    | 95016   | 钱国        | 男       | 21       | MA        | 2       | 99        |
    | 95016   | 钱国        | 男       | 21       | MA        | 4       | 82        |
    | 95017   | 王风娟       | 女       | 18       | IS        | 4       | 82        |
    | 95017   | 王风娟       | 女       | 18       | IS        | 5       | 100       |
    | 95017   | 王风娟       | 女       | 18       | IS        | 6       | 58        |
    | 95018   | 王一        | 女       | 19       | IS        | 1       | 95        |
    | 95018   | 王一        | 女       | 19       | IS        | 2       | 100       |
    | 95018   | 王一        | 女       | 19       | IS        | 3       | 67        |
    | 95018   | 王一        | 女       | 19       | IS        | 4       | 78        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 1       | 77        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 2       | 90        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 3       | 91        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 4       | 67        |
    | 95019   | 邢小丽       | 女       | 19       | IS        | 5       | 87        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 1       | 66        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 2       | 99        |
    | 95020   | 赵钱        | 男       | 21       | IS        | 5       | 93        |
    | 95021   | 周二        | 男       | 17       | MA        | 2       | 93        |
    | 95021   | 周二        | 男       | 17       | MA        | 5       | 91        |
    | 95021   | 周二        | 男       | 17       | MA        | 6       | 99        |
    | 95022   | 郑明        | 男       | 20       | MA        | 3       | 69        |
    | 95022   | 郑明        | 男       | 20       | MA        | 4       | 93        |
    | 95022   | 郑明        | 男       | 20       | MA        | 5       | 82        |
    | 95022   | 郑明        | 男       | 20       | MA        | 6       | 100       |
    +---------+-----------+---------+----------+-----------+---------+-----------+--+
    ```
- *查询与“刘晨”在同一个系学习的学生*
    - HQL
    ```
    select * from exer_student t where sdept in (select sdept from exer_student where sname = '刘晨');
    ```  
    或
    ```
    select * from exer_student t1 left semi join exer_student t2 on t1.sdept = t2.sdept and t2.sname = '刘晨';
    ```
    - 查询结果
    ```
    +---------+-----------+---------+----------+-----------+--+
    | t1.sno  | t1.sname  | t1.sex  | t1.sage  | t1.sdept  |
    +---------+-----------+---------+----------+-----------+--+
    | 95002   | 刘晨        | 女       | 19       | IS        |
    | 95004   | 张立        | 男       | 19       | IS        |
    | 95017   | 王风娟       | 女       | 18       | IS        |
    | 95018   | 王一        | 女       | 19       | IS        |
    | 95019   | 邢小丽       | 女       | 19       | IS        |
    | 95020   | 赵钱        | 男       | 21       | IS        |
    +---------+-----------+---------+----------+-----------+--+
    ```
### 2、hive自定义函数实战
- hive中自定义函数`getprovince`实现对用户上网流量数据的按电话号码的省份分区：
    - `flow.log.0`文件中的内容：
    ```
    1363157985066	13726230503	120.196.100.82	i02.c.aliimg.com	2481	24681	200
    1363157995052	13826544101	120.197.40.4		264	0	200
    1363157991076	13926435656	120.196.100.99		132	1512	200
    1363154400022	13926251106	120.197.40.4		240	0	200
    1363157993044	18211575961	120.196.100.99	iface.qiyi.com	1527	2106	200
    1363157995074	84138413	120.197.40.4	122.72.52.12	4116	1432	200
    1363157993055	13560439658	120.196.100.99		1116	954	200
    1363157995033	15920133257	120.197.40.4	sug.so.360.cn	3156	2936	200
    1363157983019	13719199419	120.196.100.82		240	0	200
    1363157984041	13660577991	120.197.40.4	s19.cnzz.com	6960	690	200
    1363157973098	15013685858	120.197.40.4	rank.ie.sogou.com	3659	3538	200
    1363157986029	15989002119	120.196.100.99	www.umeng.com	1938	180	200
    1363157992093	13560439658	120.196.100.99		918	4938	200
    1363157986041	13480253104	120.197.40.4		180	180	200
    1363157984040	13602846565	120.197.40.4	2052.flash2-http.qq.com	1938	2910	200
    1363157995093	13922314466	120.196.100.82	img.qfc.cn	3008	3720	200
    1363157982040	13502468823	120.196.100.99	y0.ifengimg.com	7335	110349	200
    1363157986072	18320173382	120.196.100.99	input.shouji.sogou.com	9531	2412	200
    1363157990043	13925057413	120.196.100.55	t3.baidu.com	11058	48243	200
    1363157988072	13760778710	120.196.100.82		120	120	200
    1363157985066	13726238888	120.196.100.82	i02.c.aliimg.com	2481	24681	200
    1363157993055	13560436666	120.196.100.99		1116	954	20	
    ```
    - 创建存储上述文件数据的hive内部表`t_flow`：
    ```
    create table t_flow (id string,phonenum string,ipaddr string,url string,upload_flow int,download_flow int,mask string)
    row format delimited fields terminated by '\t';
    ```
    - 加载数据至表中（数据文件已被上传至hdfs）：
    ```
    load data inpath '/wordcount/input/flow.log.0' into table t_flow;
    ```  
    执行`select * from t_flow`，结果如下：
    
    ```
    +----------------+------------------+-----------------+--------------------------+---------------------+-----------------------+--------------+--+
    |   t_flow.id    | t_flow.phonenum  |  t_flow.ipaddr  |        t_flow.url        | t_flow.upload_flow  | t_flow.download_flow  | t_flow.mask  |
    +----------------+------------------+-----------------+--------------------------+---------------------+-----------------------+--------------+--+
    | 1363157985066  | 13726230503      | 120.196.100.82  | i02.c.aliimg.com         | 2481                | 24681                 | 200          |
    | 1363157995052  | 13826544101      | 120.197.40.4    |                          | 264                 | 0                     | 200          |
    | 1363157991076  | 13926435656      | 120.196.100.99  |                          | 132                 | 1512                  | 200          |
    | 1363154400022  | 13926251106      | 120.197.40.4    |                          | 240                 | 0                     | 200          |
    | 1363157993044  | 18211575961      | 120.196.100.99  | iface.qiyi.com           | 1527                | 2106                  | 200          |
    | 1363157995074  | 84138413         | 120.197.40.4    | 122.72.52.12             | 4116                | 1432                  | 200          |
    | 1363157993055  | 13560439658      | 120.196.100.99  |                          | 1116                | 954                   | 200          |
    | 1363157995033  | 15920133257      | 120.197.40.4    | sug.so.360.cn            | 3156                | 2936                  | 200          |
    | 1363157983019  | 13719199419      | 120.196.100.82  |                          | 240                 | 0                     | 200          |
    | 1363157984041  | 13660577991      | 120.197.40.4    | s19.cnzz.com             | 6960                | 690                   | 200          |
    | 1363157973098  | 15013685858      | 120.197.40.4    | rank.ie.sogou.com        | 3659                | 3538                  | 200          |
    | 1363157986029  | 15989002119      | 120.196.100.99  | www.umeng.com            | 1938                | 180                   | 200          |
    | 1363157992093  | 13560439658      | 120.196.100.99  |                          | 918                 | 4938                  | 200          |
    | 1363157986041  | 13480253104      | 120.197.40.4    |                          | 180                 | 180                   | 200          |
    | 1363157984040  | 13602846565      | 120.197.40.4    | 2052.flash2-http.qq.com  | 1938                | 2910                  | 200          |
    | 1363157995093  | 13922314466      | 120.196.100.82  | img.qfc.cn               | 3008                | 3720                  | 200          |
    | 1363157982040  | 13502468823      | 120.196.100.99  | y0.ifengimg.com          | 7335                | 110349                | 200          |
    | 1363157986072  | 18320173382      | 120.196.100.99  | input.shouji.sogou.com   | 9531                | 2412                  | 200          |
    | 1363157990043  | 13925057413      | 120.196.100.55  | t3.baidu.com             | 11058               | 48243                 | 200          |
    | 1363157988072  | 13760778710      | 120.196.100.82  |                          | 120                 | 120                   | 200          |
    | 1363157985066  | 13726238888      | 120.196.100.82  | i02.c.aliimg.com         | 2481                | 24681                 | 200          |
    | 1363157993055  | 13560436666      | 120.196.100.99  |                          | 1116                | 954                   | 20           |
    +----------------+------------------+-----------------+--------------------------+---------------------+-----------------------+--------------+--+
    ```
    - 开发一个java类，按电话号码分区省份，打成`provincePartitionerUdf.jar`：
    
    ```
    package com.nwnu.hadoop.hive.udf;

    import java.util.HashMap;
    
    import org.apache.hadoop.hive.ql.exec.UDF;
    
    public class ProvincePartitionerUdf extends UDF{
    	public static HashMap<String,String> provinceDict = new HashMap<>();
        static {
            provinceDict.put("135","Lanzhou");
            provinceDict.put("136","Beijing");
            provinceDict.put("137","Shanghai");
            provinceDict.put("138","Tibet");
            provinceDict.put("139","Tianjin");
        }
        
        public String evaluate(String phoneNumber) {
        	String phoneNumberPrefix = phoneNumber.toString().substring(0,3);
        	String province = provinceDict.get(phoneNumberPrefix);
            return province == null?"other":province;
        }
    
    }
    ```
    - hive中创建`getprovince`UDF：
    ```
    add JAR /root/hadoop_jars/provincePartitionerUdf.jar;
    create temporary function getprovince as 'com.nwnu.hadoop.hive.udf.ProvincePartitionerUdf';
    ```
    - 测试UDF `getprovince`：  
    ```
    select id,phonenum,getprovince(phonenum) from t_flow;
    ```  
    查询结果如下：  
    
    ```
    +----------------+--------------+-----------+--+
    |       id       |   phonenum   |    _c2    |
    +----------------+--------------+-----------+--+
    | 1363157985066  | 13726230503  | Shanghai  |
    | 1363157995052  | 13826544101  | Tibet     |
    | 1363157991076  | 13926435656  | Tianjin   |
    | 1363154400022  | 13926251106  | Tianjin   |
    | 1363157993044  | 18211575961  | other     |
    | 1363157995074  | 84138413     | other     |
    | 1363157993055  | 13560439658  | Lanzhou   |
    | 1363157995033  | 15920133257  | other     |
    | 1363157983019  | 13719199419  | Shanghai  |
    | 1363157984041  | 13660577991  | Beijing   |
    | 1363157973098  | 15013685858  | other     |
    | 1363157986029  | 15989002119  | other     |
    | 1363157992093  | 13560439658  | Lanzhou   |
    | 1363157986041  | 13480253104  | other     |
    | 1363157984040  | 13602846565  | Beijing   |
    | 1363157995093  | 13922314466  | Tianjin   |
    | 1363157982040  | 13502468823  | Lanzhou   |
    | 1363157986072  | 18320173382  | other     |
    | 1363157990043  | 13925057413  | Tianjin   |
    | 1363157988072  | 13760778710  | Shanghai  |
    | 1363157985066  | 13726238888  | Shanghai  |
    | 1363157993055  | 13560436666  | Lanzhou   |
    +----------------+--------------+-----------+--+
    ```
- hive中通过`transform`语法调用自己写的python脚本实现对用户上网流量数据的按电话号码的省份分区：
    - python3脚本`getprovince.py`：
        ```
        #!/usr/bin/python3
        import sys
        
        provinceDict = {"135":"Lanzhou","136":"Beijing","137":"Shanghai","138":"Tibet","139":"Tianjin"}
        
        for line in sys.stdin:
          line = line.strip()
          uid,phoneNum = line.split('\t')
          # 取出电话号码前3位
          phoneNumPrefix = phoneNum[0:3]
          province = provinceDict.get(phoneNumPrefix,"other")
          print('\t'.join([uid,province])
        ```
    - 给`getprovince.py`赋予执行权限：`chmod 755 getprovince.py`（*重要，否则后面的子查询语句会报错*）
    - hive中通过`transform`语法调用`getprovince.py`脚本实现按省份分区：
        ```
        add FILE /root/hadoop_testfiles/hive_python/getprovince.py;
        
        /*select transform(id,phonenum) using 'getprovince.py' as (uid,province) from t_flow;*/
        
        select t1.id,t1.phonenum,t2.province from t_flow t1 left join (select transform(id,phonenum) using 'getprovince.py' as (uid,province) from t_flow) t2 on t1.id = t2.uid;
        ```
- 解析json文件内容存入到hive表中：
    - `rating.json`文件内容（总共1000209行）：
        ```
        {"movie":"1193","rate":"5","timeStamp":"978300760","uid":"1"}
        {"movie":"661","rate":"3","timeStamp":"978302109","uid":"1"}
        {"movie":"914","rate":"3","timeStamp":"978301968","uid":"1"}
        {"movie":"3408","rate":"4","timeStamp":"978300275","uid":"1"}
        {"movie":"2355","rate":"5","timeStamp":"978824291","uid":"1"}
        ...
        {"movie":"1096","rate":"4","timeStamp":"956715648","uid":"6040"}
        {"movie":"1097","rate":"4","timeStamp":"956715569","uid":"6040"}
        ```
    - 创建hive新表`t_json`，并将json数据导入：
        ```
        create table t_json(line string)
        row format delimited;
        load data inpath '/root/hadoop_testfiles/hive_json/rating.json' into table t_json;
        ```
    - 创建`JsonParser`java类，重载`evaluate()`方法，打成jar包`parseJsonUdf.jar`传到服务器目录`/root/hadoop_testfiles/hive_json/`：  
        `JsonParser.java`：
        ```
        package com.nwnu.hadoop.hive.udf;

        import org.apache.hadoop.hive.ql.exec.UDF;
        
        import com.google.gson.Gson;
        import com.nwnu.hadoop.hive.bean.MovieRatingBean;
        
        
        public class JsonParser extends UDF{
        	public String evaluate(String jsonLine) {
                /**
                 * 将一行json字符串反解析为java bean
                 */
                Gson gson = new Gson();
                MovieRatingBean movieRatingBean = gson.fromJson(jsonLine,MovieRatingBean.class);
        		return movieRatingBean.toString();
        	}
        }
        ```  
        `MovieRatingBean.java`：
        ```
        package com.nwnu.hadoop.hive.bean;

        import lombok.Data;
        
        @Data
        public class MovieRatingBean {
        	private String movie;
        	private String rate;
        	private String timeStamp;
        	private String uid;
        	
        	@Override
        	public String toString() {
        		return movie + "\t" + rate + "\t" + timeStamp + "\t" + uid;
        	}	
        }
        ```
    - 在hive中添加add resources：`add JAR /root/hadoop_testfiles/hive_json/parseJsonUdf.jar;`
    - 在当前hive会话中创建临时函数`parsejson()`：`create temporary function parsejson as 'com.nwnu.hadoop.hive.udf.JsonParser';`
    - 创建新hive表`t_rating`导入解析后的json数据：
        ```
        create table t_rating as
        select split(parsejson(line),'\t')[0] as movieid,
        split(parsejson(line),'\t')[1] as rate,
        split(parsejson(line),'\t')[2] as time_stamp, -- timestamp为hive中关键字，不可用其命名表中字段
        split(parsejson(line),'\t')[3] as uid
        from t_json;
        ```